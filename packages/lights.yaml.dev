################################################
## Packages / Lights
################################################

################################################
## Customize
################################################
homeassistant:
  customize:
    group.all_lights:
      control: hidden
    script.all_off:
      friendly_name: All Lights Off
      icon: mdi:flash
    script.woonkamer_off:
      friendly_name: Woonkamer
      icon: mdi:flashlight-off
    script.keuken_off:
      friendly_name: Keuken
      icon: mdi:flashlight-off
    script.hal_en_overlopen_off:
      friendly_name: Hal en Overlopen
      icon: mdi:flashlight-off
    script.buiten_off:
      friendly_name: Buiten
      icon: mdi:flashlight-off
    switch.all_on:
      friendly_name: All lights
      icon: mdi:flash
    script.all_on:
      friendly_name: All Lights On
      icon: mdi:flash
    script.all_on_bright:
      friendly_name: All Lights Bright
      icon: mdi:flash
    script.all_on_super_bright:
      friendly_name: All Lights Super Bright
      icon: mdi:flash
    script.woonkamer:
      friendly_name: Woonkamer
      icon: mdi:flashlight
    script.woonkamer_nightlight:
      friendly_name: Woonkamer NL
      icon: mdi:flashlight
    script.woonkamer_bright:
      friendly_name: Woonkamer B
      icon: mdi:flashlight
    script.woonkamer_super_bright:
      friendly_name: Woonkamer SB
      icon: mdi:flashlight
    script.keuken:
      friendly_name: Keuken
      icon: mdi:flashlight
    script.keuken_bright:
      friendly_name: Keuken B
      icon: mdi:flashlight
    script.keuken_super_bright:
      friendly_name: Keuken SB
      icon: mdi:flashlight
    script.hal_en_overlopen:
      friendly_name: Hal & Overlopen
      icon: mdi:flashlight
    script.hal_en_overlopen_nightlight:
      friendly_name: Hal & Overlopen NL
      icon: mdi:flashlight
    script.hal_en_overlopen_bright:
      friendly_name: Hal & Overlopen B
      icon: mdi:flashlight
    script.hal_en_overlopen_super_bright:
      friendly_name: Hal & Overlopen SB
      icon: mdi:flashlight
    script.buiten:
      friendly_name: Buiten
      icon: mdi:flashlight
    script.buiten_bright:
      friendly_name: Buiten B
      icon: mdi:flashlight
    script.buiten_super_bright:
      friendly_name: Buiten SB
      icon: mdi:flashlight
    sensor.woonkamer_motion:
      friendly_name: Woonkamer Motion
      icon: mdi:run-fast
    sensor.woonkamer_lux:
      friendly_name: Woonkamer Lux
      icon: mdi:theme-light-dark
    sensor.woonkamer_battery:
      friendly_name: Woonkamer Battery
      icon: mdi:battery
    sensor.hal_motion:
      friendly_name: Hal Motion
      icon: mdi:run-fast
    sensor.hal_lux:
      friendly_name: Hal Lux
      icon: mdi:theme-light-dark
    sensor.hal_battery:
      friendly_name: Hal Battery
      icon: mdi:battery
    sensor.switch_hal:
      friendly_name: Switch Hal
    sensor.switch_woonkamer:
      friendly_name: Switch Woonkamer
    sensor.hue_remote_1_state:
      friendly_name: Remote 1 State
      icon: mdi:remote
      persistence: false
    sensor.hue_remote_1_last_update:
      friendly_name: Remote 1 Last Update
      icon: mdi:clock
    sensor.hue_remote_1_battery:
      friendly_name: Remote 1 Battery
      icon: mdi:battery
    sensor.hue_remote_2_state:
      friendly_name: Remote 2 State
      icon: mdi:remote
      persistence: false
    sensor.hue_remote_2_last_update:
      friendly_name: Remote 2 Last Update
      icon: mdi:clock
    sensor.hue_remote_2_battery:
      friendly_name: Remote 2 Battery
      icon: mdi:battery
    input_number.keuken_hanglamp_brightness:
      friendly_name: Keuken Hanglamp


################################################
## Hue
################################################
hue:
  bridges:
    - host: !secret philips_hue_host
      allow_unreachable: true
      allow_hue_groups: true

################################################
## Input Number
################################################
input_number:
  keuken_hanglamp_brightness:
    initial: 127
    min: 0
    max: 255
    step: 1

input_select:
  light_scenes:
    name: Scenes
    options:
      - "Select Scene"
      - "On"
      - "Off"
      - "Bright"
      - "Super Bright"
    initial: "Select Scene"
    icon: mdi:creation

################################################
## Sensor
################################################
sensor:
  - platform: rest
    resource: !secret hue_woonkamer_battery_sensor
    value_template: '{{ value_json.config.battery }}'
    scan_interval: 1800
    unit_of_measurement: '%'
    name: 'woonkamer_battery'
  - platform: rest
    resource: !secret hue_woonkamer_motion_sensor
    value_template: '{{ value_json.state.presence }}'
    scan_interval: 1
    name: 'woonkamer_motion'
  - platform: rest
    resource: !secret hue_woonkamer_lux_sensor
  #  value_template: '{{(10 ** (float (value_json.state.lightlevel) / 10000) -1) | round (1)}}'
    value_template: '{{ value_json.state.lightlevel }}'
    scan_interval: 30
    unit_of_measurement: 'Lux'
    name: 'woonkamer_lux'

  # Philips HUE - Sensors - Hal en Overlopen
  - platform: rest
    resource: !secret hue_hal_battery_sensor
    value_template: '{{ value_json.config.battery }}'
    scan_interval: 1800
    unit_of_measurement: '%'
    name: 'hal_battery'
  - platform: rest
    resource: !secret hue_hal_motion_sensor
    value_template: '{{ value_json.state.presence }}'
    scan_interval: 1
    name: 'hal_motion'
  - platform: rest
    resource: !secret hue_hal_lux_sensor
    value_template: '{{ value_json.state.lightlevel }}'
    scan_interval: 30
    unit_of_measurement: 'Lux'
    name: 'hal_lux'

  # Philips HUE - Remote 1
  - platform: rest
    resource: !secret hue_remote_1
    value_template: '{{ value_json.config.battery }}'
    unit_of_measurement: '%'
    scan_interval: 1800
    name: 'hue_remote_1_battery'
  - platform: rest
    resource: !secret hue_remote_1
    value_template: '{{ value_json.state.buttonevent }}'
    scan_interval: 1
    name: 'hue_remote_1_state'
  - platform: template
    sensors:
      hue_remote_1_state:
        friendly_name: 'hue_remote_1_state'
        value_template: >-
                      {% if states('sensor.hue_remote_1_state_2')[0] == "1" %}
                        On
                      {% elif states('sensor.hue_remote_1_state_2')[0] == "2" %}
                        Dim Up
                      {% elif states('sensor.hue_remote_1_state_2')[0] == "3" %}
                        Dim Down
                      {% elif states('sensor.hue_remote_1_state_2')[0] == "4" %}
                        Off
                      {% else %}
                        None
                      {% endif %}
  - platform: rest
    resource: !secret hue_remote_1
    value_template: '{{ value_json.state.lastupdated }}'
    scan_interval: 10
    name: 'hue_remote_1_last_update'
  - platform: template
    sensors:
      hue_remote_1_last_update:
        friendly_name: 'hue_remote_1_last_used'
        value_template: >-
          {{ as_timestamp(strptime(states('sensor.hue_remote_1_last_update_2')[:19], "%Y-%m-%dT%X"))|timestamp_custom("%a, %B %d")}}

  # Philips HUE - Remote 2
  - platform: rest
    resource: !secret hue_remote_2
    value_template: '{{ value_json.config.battery }}'
    unit_of_measurement: '%'
    scan_interval: 1800
    name: 'hue_remote_2_battery'
  - platform: rest
    resource: !secret hue_remote_2
    value_template: '{{ value_json.state.buttonevent }}'
    scan_interval: 1
    name: 'hue_remote_2_state'
  - platform: template
    sensors:
      hue_remote_2_state:
        friendly_name: 'hue_remote_2_state'
        value_template: >-
                      {% if states('sensor.hue_remote_2_state_2')[0] == "1" %}
                        On
                      {% elif states('sensor.hue_remote_2_state_2')[0] == "2" %}
                        Dim Up
                      {% elif states('sensor.hue_remote_2_state_2')[0] == "3" %}
                        Dim Down
                      {% elif states('sensor.hue_remote_2_state_2')[0] == "4" %}
                        Off
                      {% else %}
                        None
                      {% endif %}
  - platform: rest
    resource: !secret hue_remote_2
    value_template: '{{ value_json.state.lastupdated }}'
    scan_interval: 10
    name: 'hue_remote_2_last_update'
  - platform: template
    sensors:
      hue_remote_2_last_update:
        friendly_name: 'hue_remote_2_last_used'
        value_template: >-
          {{ as_timestamp(strptime(states('sensor.hue_remote_2_last_update_2')[:19], "%Y-%m-%dT%X"))|timestamp_custom("%a, %B %d")}}

  - platform: template
    sensors:
      keuken_hanglamp_brightness:
        value_template: >-
          {%- if is_state('light.keuken_hanglamp', 'on') -%}
            {{ states.light.keuken_hanglamp.attributes.brightness | int }}
          {%- else -%}
            127
          {%- endif -%}
      switch_hal:
        value_template: >-
          {%- if states('sensor.hal_lux') | int < 8000 -%}
            on
          {%- else -%}
            off
          {%- endif -%}
      switch_woonkamer:
        value_template: >-
          {%- if states('sensor.woonkamer_lux') | int < 14000 -%}
            on
          {%- else -%}
            off
          {%- endif -%}


################################################
## Automation
################################################
automation:
  - alias: "Slider - Keuken - Hanglamp - Set value"
    initial_state: on
    trigger:
    - platform: state
      entity_id: sensor.keuken_hanglamp_brightness
    - platform: state
      entity_id: light.keuken_hanglamp
      from: 'off'
      to: 'on'
    - platform: homeassistant
      event: start
    action:
    - service: input_number.set_value
      data_template:
        entity_id: input_number.keuken_hanglamp_brightness
        value: "{{ states.light.keuken_hanglamp.attributes.brightness | int }}"
        #value: "{{ states.sensor.keuken_hanglamp_brightness | int }}"

  - alias: "Switch - Keuken - Hanglamp - On"
    trigger:
    - platform: state
      entity_id: input_number.keuken_hanglamp_brightness
    action:
    - service: light.turn_on
      data_template:
        entity_id: light.keuken_hanglamp
        brightness: "{{ trigger.to_state.state | int }}"


  - alias: "Automation - All - Turn off"
    trigger:
    - platform: state
      entity_id: input_boolean.automation_mode
      to: 'on'
    condition:
    - condition: state
      entity_id: input_boolean.automation_mode
      state: 'on'
    action:
    - service: script.turn_on
      entity_id:
      - script.all_off
      - script.woonkamer_off
      - script.keuken_off
      - script.hal_en_overlopen_off
      - script.buiten_off
    - service: switch.turn_off
      entity_id:
      - switch.smartplug2

  - alias: "Motion and Person - Doorbel - Turn On"
    trigger:
    - platform: state
      entity_id: binary_sensor.front_door_camera_voordeur_motion_detected
      to: 'on'
    - platform: state
      entity_id: binary_sensor.front_door_camera_voordeur_person_detected
      to: 'on'
    condition:
    - condition: time
      before: '05:00:00'
      after: '00:00:00'
    - condition: state
      entity_id: binary_sensor.front_door_camera_voordeur_motion_detected
      state: 'on'
    action:
    - service: script.turn_on
      entity_id:
      - script.buiten_bright

  - alias: "Motion and Person - Doorbel - Turn Off"
    trigger:
    - platform: state
      entity_id: binary_sensor.front_door_camera_voordeur_motion_detected
      to: 'off'
      for:
        minutes: 10
    - platform: state
      entity_id: binary_sensor.front_door_camera_voordeur_person_detected
      to: 'off'
      for:
        minutes: 10
    condition:
    - condition: time
      before: '5:00:00'
      after: '00:00:00'
    - condition: state
      entity_id: binary_sensor.front_door_camera_voordeur_motion_detected
      state: 'off'
    action:
    - service: script.turn_on
      entity_id:
      - script.buiten_off

  - alias: "Switch - Woonkamer - Daytime/Evening on"
    trigger:
    - platform: state
      entity_id: sensor.switch_woonkamer
      from: 'off'
      to: 'on'
      for:
        minutes: 5
    - platform: state
      entity_id: sensor.hal_motion
      to: 'True'
    - platform: state
      entity_id: sensor.woonkamer_motion
      to: 'True'
    condition:
    - condition: time
      before: '00:00:00'
      after: '5:00:00'
    - condition: state
      entity_id: sensor.switch_woonkamer
      state: 'on'
    - condition: state
      entity_id: sensor.switch_hal
      state: 'on'
    - condition: state
      entity_id: input_boolean.automation_mode
      state: 'off'
    action:
    - service: script.turn_on
      entity_id:
      - script.woonkamer
      - script.keuken
      - script.buiten
    - service: switch.turn_on
      entity_id:
      - switch.smartplug2

  - alias: "Switch - Woonkamer - Off - Lux"
    trigger:
    - platform: state
      entity_id: sensor.switch_woonkamer
      from: 'on'
      to: 'off'
      for:
        minutes: 5
    condition:
    - condition: state
      entity_id: input_boolean.automation_mode
      state: 'off'
    action:
    - service: script.turn_on
      entity_id:
      - script.all_off

  - alias: "Switch - Woonkamer - Off - Time"
    trigger:
    - platform: time
      minutes: '/10'
      seconds: 00
    condition:
    - condition: time
      after: '21:00:00'
      before: '05:00:00'
    - condition: state
      entity_id: media_player.livingroom_tv
      state: 'off'
    - condition: state
      entity_id: input_boolean.automation_mode
      state: 'off'
    action:
    - service: script.turn_on
      entity_id:
      - script.all_off

  - alias: "Motion - Hal en overlopen - Morning and evening on"
    trigger:
    - platform: state
      entity_id: sensor.hal_motion
      to: 'True'
    condition:
    - condition: and
      conditions:
      - condition: time
        before: '06:00:00'
        after: '21:00:00'
      - condition: state
        entity_id: sensor.switch_hal
        state: 'on'
    action:
    - service: script.turn_on
      entity_id:
      - script.hal_en_overlopen_nightlight

  - alias: "Motion - Hal en overlopen - Daytime on"
    trigger:
    - platform: state
      entity_id: sensor.hal_motion
      to: 'True'
    condition:
    - condition: and
      conditions:
      - condition: time
        before: '21:00:00'
        after: '06:00:00'
      - condition: state
        entity_id: sensor.switch_hal
        state: 'on'
    action:
    - service: script.turn_on
      entity_id:
      - script.hal_en_overlopen

  - alias: "Motion - Hal en overlopen - Off"
    trigger:
    - platform: state
      entity_id: sensor.hal_motion
      to: 'False'
      for:
        minutes: 10
    action:
    - service: script.turn_on
      entity_id:
      - script.hal_en_overlopen_off


################################################
## Scenes
################################################
scene:
  - name: general_one
    entities:
      light.woonkamer:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 35
      light.keuken:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 35
      light.keuken_hanglamp:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 25
      light.hal_en_overlopen:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 35
  - name: general_two
    entities:
      light.woonkamer:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 45
      light.keuken:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 45
      light.keuken_hanglamp:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 35
      light.hal_en_overlopen:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 45
  - name: general_three
    entities:
      light.woonkamer:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 60
      light.keuken:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 60
      light.keuken_hanglamp:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 50
      light.hal_en_overlopen:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 60
  - name: general_four
    entities:
      light.woonkamer:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 75
      light.keuken:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 75
      light.keuken_hanglamp:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 75
      light.hal_en_overlopen:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 75
  - name: general_five
    entities:
      light.woonkamer:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 100
      light.keuken:
        state: true1
        xy_color: [0.52, 0.41]
        brightness_pct: 100
      light.keuken_hanglamp:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 100
      light.hal_en_overlopen:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 100

  - name: buiten_one
    entities:
      light.buitenvoor:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 35
      light.buitenachter:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 35
  - name: buiten_two
    entities:
      light.buitenvoor:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 45
      light.buitenachter:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 45
  - name: buiten_three
    entities:
      light.buitenvoor:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 60
      light.buitenachter:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 60
  - name: buiten_four
    entities:
      light.buitenvoor:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 75
      light.buitenachter:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 75
  - name: buiten_five
    entities:
      light.buitenvoor:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 100
      light.buitenachter:
        state: true
        xy_color: [0.52, 0.41]
        brightness_pct: 100


################################################
## Script
################################################
script:
  time_test:
    alias: Time Test
    sequence:
    - service: scene.turn_on
      data_template:
        entity_id: >
          scene.general_
          {%-  if now().hour < 7 %}one
          {% elif now().hour < 20 %}two
          {% elif now().hour >= 21 %}one
          {% endif %}

#  one:
#    sequence:
#    - service: scene.turn_on
#      entity_id: scene.one

  all_off:
    sequence:
    - service: light.turn_off
      entity_id:
      - light.woonkamer
      - light.keuken
      - light.buitenvoor
      - light.buitenachter
    - service: switch.turn_off
      entity_id:
        - switch.smartplug2